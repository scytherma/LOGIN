<!DOCTYPE html>
<html lang="pt-BR">
<head> 
    <link rel="icon" type="image/png" href="https://i.ibb.co/tyjmnjV/FAVCON-LUCRE-CERTO-FOGUETE.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Precificação - Lucre Certo</title>
    <link rel="stylesheet" href="./styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="./script.js"></script>
</head>
<body>
    <!-- Loading screen -->
    <div id="loading-screen" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100% );
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    ">
        <div style="text-align: center;">
            <div style="
                width: 50px;
                height: 50px;
                border: 3px solid rgba(255,255,255,0.3);
                border-top: 3px solid white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            "></div>
            <p>Carregando...</p>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- Header com logo e usuário (inicialmente oculto) -->
    <div class="user-header" id="user-header" style="display: none;">
        <div class="logo-container">
            <img src="https://i.postimg.cc/KYqk4xX2/LOGO-LUCRE-CERTO-FOGUETE.png" class="logo">
        </div>
        <div class="user-info">
            <span id="userName">Carregando...</span>
            <button onclick="logout( )" class="logout-btn">Sair</button>
        </div>
    </div>

    <div class="container" id="main-content" style="display: none;">
        <!-- Sistema de Abas -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" data-tab="shopee">Calculadora Shopee</button>
                <button class="tab-button" data-tab="mercadolivre">Calculadora Mercado Livre</button>
                <button class="tab-button disabled" data-tab="shein">Calculadora Shein</button>
            </div>

            <div class="tabs-content">
                <!-- Conteúdo da Aba Shopee -->
                <div class="tab-content active" id="shopee-tab">
                    <div class="calculator-container">
                        <div class="left-panel">
                            <div class="form-group">
                                <label for="shopee-custo">
                                    CUSTO DO PRODUTO 
                                    <span class="add-btn" onclick="addShopeeField('custo')">+</span>
                                    <span class="info-icon" title="Valor que você paga pelo produto">?</span>
                                </label>
                                <div class="input-container">
                                    <span class="currency">R$</span>
                                    <input type="text" id="shopee-custo" placeholder="0,00" oninput="formatCurrency(this); calculateShopee()">
                                    <select class="multiplier-select" onchange="calculateShopee()">
                                        <option value="1">1x</option>
                                        <option value="2">2x</option>
                                        <option value="3">3x</option>
                                        <option value="4">4x</option>
                                        <option value="5">5x</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="shopee-imposto">
                                    IMPOSTO
                                    <span class="info-icon" title="Percentual de impostos sobre o produto">?</span>
                                </label>
                                <div class="input-container">
                                    <span class="currency">%</span>
                                    <input type="text" id="shopee-imposto" placeholder="0" oninput="calculateShopee()">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="shopee-despesas">
                                    DESPESAS VARIÁVEIS
                                    <span class="info-icon" title="Custos variáveis como embalagem, etiquetas, etc.">?</span>
                                </label>
                                <div class="input-container">
                                    <span class="currency">R$</span>
                                    <input type="text" id="shopee-despesas" placeholder="0,00" oninput="formatCurrency(this); calculateShopee()">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="shopee-custo-extra">
                                    CUSTO EXTRA 
                                    <span class="add-btn" onclick="addShopeeField('extra')">+</span>
                                    <span class="info-icon" title="Custos adicionais não previstos">?</span>
                                </label>
                                <div class="input-container">
                                    <select class="currency-select" onchange="calculateShopee()">
                                        <option value="R$">R$</option>
                                        <option value="%">%</option>
                                    </select>
                                    <input type="text" id="shopee-custo-extra" placeholder="0,00" oninput="handleCustoExtraInput(this, 'shopee'); calculateShopee()">
                                </div>
                            </div>
                        </div>

                        <div class="right-panel">
                            <div class="result-card">
                                <div class="result-row">
                                    <div class="result-item main">
                                        <span class="label">Preço de Venda</span>
                                        <span class="value" id="shopee-preco-venda">R$ 0,00</span>
                                    </div>
                                    <div class="result-item main">
                                        <span class="label">Lucro por Venda</span>
                                        <span class="value profit" id="shopee-lucro">R$ 0,00</span>
                                    </div>
                                </div>

                                <div class="result-row">
                                    <div class="result-item">
                                        <span class="label">Taxa da Shopee</span>
                                        <span class="value" id="shopee-taxa">R$ 0,00</span>
                                    </div>
                                    <div class="result-item">
                                        <span class="label">Valor dos Impostos</span>
                                        <span class="value" id="shopee-valor-impostos">R$ 0,00</span>
                                    </div>
                                    <div class="result-item">
                                        <span class="label">Custo Total do Produto</span>
                                        <span class="value" id="shopee-custo-total">R$ 0,00</span>
                                    </div>
                                </div>

                                <div class="result-row">
                                    <div class="result-item">
                                        <span class="label">Retorno sobre Produto</span>
                                        <span class="value" id="shopee-retorno">0%</span>
                                    </div>
                                    <div class="result-item">
                                        <span class="label">Markup %</span>
                                        <span class="value" id="shopee-markup-percent">0%</span>
                                    </div>
                                    <div class="result-item">
                                        <span class="label">Markup X</span>
                                        <span class="value" id="shopee-markup-x">0X</span>
                                    </div>
                                </div>
                            </div>

                            <div class="margin-control">
                                <label>MARGEM DE LUCRO</label>
                                <div class="slider-container">
                                    <input type="range" id="shopee-margin-slider" min="0" max="100" value="0" oninput="updateShopeeMargin(this.value)">
                                    <span class="margin-value" id="shopee-margin-display">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conteúdo da Aba Mercado Livre -->
                <div class="tab-content" id="mercadolivre-tab">
                    <div class="calculator-container">
                        <div class="left-panel">
                            <div class="form-group">
                                <label for="ml-custo">
                                    CUSTO DO PRODUTO 
                                    <span class="add-btn" onclick="addMLField('custo')">+</span>
                                    <span class="info-icon" title="Valor que você paga pelo produto">?</span>
                                </label>
                                <div class="input-container">
                                    <span class="currency">R$</span>
                                    <input type="text" id="ml-custo" placeholder="0,00" oninput="formatCurrency(this); calculateML()">
                                    <select class="multiplier-select" onchange="calculateML()">
                                        <option value="1">1x</option>
                                        <option value="2">2x</option>
                                        <option value="3">3x</option>
                                        <option value="4">4x</option>
                                        <option value="5">5x</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="ml-imposto">
                                    IMPOSTO
                                    <span class="info-icon" title="Percentual de impostos sobre o produto">?</span>
                                </label>
                                <div class="input-container">
                                    <span class="currency">%</span>
                                    <input type="text" id="ml-imposto" placeholder="0" oninput="calculateML()">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="ml-despesas">
                                    DESPESAS VARIÁVEIS
                                    <span class="info-icon" title="Custos variáveis como embalagem, etiquetas, etc.">?</span>
                                </label>
                                <div class="input-container">
                                    <span class="currency">R$</span>
                                    <input type="text" id="ml-despesas" placeholder="0,00" oninput="formatCurrency(this); calculateML()">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="ml-taxa-categoria">
                                    TAXA DO MERCADO LIVRE
                                    <span class="info-icon" title="Taxa de comissão do Mercado Livre por categoria">?</span>
                                </label>
                                <div class="input-container">
                                    <select id="ml-taxa-categoria" onchange="calculateML()">
                                        <option value="12">Geral - Clássico (12%)</option>
                                        <option value="15">Geral - Premium (15%)</option>
                                        <option value="14">Eletrônicos - Clássico (14%)</option>
                                        <option value="17">Eletrônicos - Premium (17%)</option>
                                        <option value="16">Moda - Clássico (16%)</option>
                                        <option value="19">Moda - Premium (19%)</option>
                                        <option value="13">Casa e Jardim - Clássico (13%)</option>
                                        <option value="16">Casa e Jardim - Premium (16%)</option>
                                        <option value="11">Esportes - Clássico (11%)</option>
                                        <option value="14">Esportes - Premium (14%)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="ml-frete">
                                    TAXA DE FRETE
                                    <span class="info-icon" title="Custo de envio baseado no peso e valor">?</span>
                                </label>
                                <div class="input-container">
                                    <select id="ml-frete" onchange="calculateML()">
                                        <option value="0">Frete Grátis (R$ 19-78,99)</option>
                                        <option value="15.90">Até 300g (R$ 15,90)</option>
                                        <option value="19.90">301g a 500g (R$ 19,90)</option>
                                        <option value="24.90">501g a 1kg (R$ 24,90)</option>
                                        <option value="29.90">1kg a 2kg (R$ 29,90)</option>
                                        <option value="39.90">2kg a 5kg (R$ 39,90)</option>
                                        <option value="49.90">5kg a 10kg (R$ 49,90)</option>
                                        <option value="59.90">10kg a 20kg (R$ 59,90)</option>
                                        <option value="79.90">20kg a 30kg (R$ 79,90)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="ml-custo-extra">
                                    CUSTO EXTRA 
                                    <span class="add-btn" onclick="addMLField('extra')">+</span>
                                    <span class="info-icon" title="Custos adicionais não previstos">?</span>
                                </label>
                                <div class="input-container">
                                    <select class="currency-select" onchange="calculateML()">
                                        <option value="R$">R$</option>
                                        <option value="%">%</option>
                                    </select>
                                    <input type="text" id="ml-custo-extra" placeholder="0,00" oninput="handleCustoExtraInput(this, 'ml'); calculateML()">
                                </div>
                            </div>
                        </div>

                        <div class="right-panel">
                            <div class="result-card">
                                <div class="result-row">
                                    <div class="result-item main">
                                        <span class="label">Preço de Venda</span>
                                        <span class="value" id="ml-preco-venda">R$ 0,00</span>
                                    </div>
                                    <div class="result-item main">
                                        <span class="label">Lucro por Venda</span>
                                        <span class="value profit" id="ml-lucro">R$ 0,00</span>
                                    </div>
                                </div>

                                <div class="result-row">
                                    <div class="result-item">
                                        <span class="label">Taxa da ML</span>
                                        <span class="value" id="ml-taxa">R$ 0,00</span>
                                    </div>
                                    <div class="result-item">
                                        <span class="label">Valor dos Impostos</span>
                                        <span class="value" id="ml-valor-impostos">R$ 0,00</span>
                                    </div>
                                    <div class="result-item">
                                        <span class="label">Custo Total do Produto</span>
                                        <span class="value" id="ml-custo-total">R$ 0,00</span>
                                    </div>
                                </div>

                                <div class="result-row">
                                    <div class="result-item">
                                        <span class="label">Retorno sobre Produto</span>
                                        <span class="value" id="ml-retorno">0%</span>
                                    </div>
                                    <div class="result-item">
                                        <span class="label">Markup %</span>
                                        <span class="value" id="ml-markup-percent">0%</span>
                                    </div>
                                    <div class="result-item">
                                        <span class="label">Markup X</span>
                                        <span class="value" id="ml-markup-x">0X</span>
                                    </div>
                                </div>
                            </div>

                            <div class="margin-control">
                                <label>MARGEM DE LUCRO</label>
                                <div class="slider-container">
                                    <input type="range" id="ml-margin-slider" min="0" max="100" value="0" oninput="updateMLMargin(this.value)">
                                    <span class="margin-value" id="ml-margin-display">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conteúdo da Aba Shein (Placeholder) -->
                <div class="tab-content" id="shein-tab">
                    <div class="coming-soon">
                        <h2>Calculadora Shein</h2>
                        <p>Em breve...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="./script.js"></script>
    <script src="./supabase-config.js"></script>
    <script src="./auth-supabase.js"></script>
    <script>
        // Verificar autenticação ao carregar a página
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                if (user) {
                    // Usuário logado - mostrar calculadora
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('user-header').style.display = 'flex';
                    document.getElementById('main-content').style.display = 'block';
                    
                    // Atualizar nome do usuário
                    const displayName = user.user_metadata?.name || user.email.split('@')[0];
                    document.getElementById('userName').textContent = `Olá, ${displayName}`;
                } else {
                    // Usuário não logado - redirecionar para login
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Erro ao verificar autenticação:', error);
                // Em caso de erro, redirecionar para login
                window.location.href = 'login.html';
            }
        });

        // Função de logout
        async function logout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                
                if (error) {
                    throw error;
                }
                
                window.location.href = 'login.html';
                
            } catch (error) {
                console.error('Erro no logout:', error);
                // Mesmo com erro, redirecionar para login
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>
